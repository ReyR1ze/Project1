import psycopg2
import redis
import json

# Подключение к PostgreSQL
conn_psql = psycopg2.connect(
    host="localhost",
    database="nanoedu",
    user="ваш_пользователь",
    password="ваш_пароль"
)
cursor = conn_psql.cursor()

# SQL-запрос с объединением таблиц и агрегацией
query = """
SELECT 
    r.name AS region_name,
    COUNT(e.id) AS equipment_count,
    SUM(e.cost) AS total_cost
FROM sp_region r
LEFT JOIN table4_equipment e ON r.id = e.region_id
GROUP BY r.name
ORDER BY r.name;
"""

cursor.execute(query)
results = cursor.fetchall()

# Подключение к Redis
r = redis.Redis(
    host='localhost',
    port=6379,
    decode_responses=True
)

# Запись данных в Redis
for region, count, cost in results:
    key = f"region:{region}"
    value = {
        "equipment_count": count,
        "total_cost": float(cost) if cost else 0.0
    }
    r.set(key, json.dumps(value))

# Проверка записи
for key in r.keys("region:*"):
    print(f"{key}: {r.get(key)}")

cursor.close()
conn_psql.close()
